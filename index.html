<!DOCTYPE html>
<html class=''>

<head>
  <meta charset='UTF-8'>
  <meta name="robots" content="noindex">


  <style class="cp-pen-styles">
    .link {
      fill: none;
      stroke: #555;
      stroke-opacity: 0.4;
      stroke-width: 1.5px;
    }

    .drag .link {
      stroke-dasharray: 1;
    }

    .drag circle.fake {
      fill: none;
      stroke: #555;
      stroke-dasharray: 1;
    }
    text {
      font-size: 10px;
      text-anchor: middle;
    }
  </style>
</head>

<body>

  <svg width="960" height="600">
    <g transform="translate(0,0)" class="tree"></g>
    <g transform="translate(0,0)" class="drag"></g>
  </svg>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src='./build/d3-logictree.js'></script>
  <script>
    var data = 0;
    var lastValue = 0;

    var svg = d3.select("svg"),
      width = +svg.attr("width"),
      height = +svg.attr("height"),
      g = svg.select("g.tree");

    var RADIUS = 25;
    var layout = new d3.logictree.LogicTreeLayout(RADIUS, width, height);

    var root = new d3.logictree.Node(data);
    layout.position(root);

    var color = d3.scaleSequential(d3.interpolateMagma)
      .domain([-4, 4]);

    var nodes = root.descendants();

    function drawTree() {
      g.selectAll("*").remove();
      if (root.isNull) return;
      var node = g.selectAll("g")
        .data(nodes)
        .enter().append("g")
        .attr("transform", function(d) {
          return "translate(" + d.x + "," + d.y + ")";
        });

      node.append("circle")
        .attr("id", function(d) {
          return "node-" + d.data;
        })
        .attr("r", function(d) {
          return 25;
        })
        .style("fill", function(d) {
          return color(1);
        });

      node.append("text")
        .append("tspan")
        .attr("x", 0)
        .attr("y", 5)
        .text(function(d) {
          return d.data;
        });

      var link = g.selectAll(".link")
        .data(layout.lines(root))
        .enter().append("path")
        .attr("class", "link")
        .attr("d", function(link) {
          if (link.length === 2) {
            return 'M' + link[0].x + ',' + link[0].y + ' L' + link[1].x + ',' + link[1].y;
          } else if (link.length === 3) {
            return 'M' + link[0].x + ',' + link[0].y +
              'C' + link[1].x + ',' + link[1].y +
              ' ' + link[1].x + ',' + link[1].y +
              ' ' + link[2].x + ',' + link[2].y;
          }
        });
    }
    drawTree();
    var Point = d3.logictree.Point;
    var point = new Point(500, 500);
    var match = null;
    var mode = null;
    var orientation = null;

    function render() {
      svg.select(".drag").selectAll("*")
        .remove()
      svg.select(".drag")
        .append("circle")
        .attr("r", layout.radius)
        .attr("cx", point.x)
        .attr("cy", point.y)
        .style("fill", color(2))
        .style("stroke", function() {
          if (point.active) return "#999999";
        });
      if (match) {
        if (mode === 'OR') {
          var o = new Point(match.x, match.y + layout.diameter + 10);
          var links = [
            [o.subtract(layout.r), o.subtract(layout.d), match.point.subtract(layout.d)],
            [o.add(layout.r), o.add(layout.d), match.point.add(layout.d)]
          ];
          svg.select(".drag")
            .append("circle")
            .attr("r", layout.radius)
            .attr("cx", o.x)
            .attr("cy", o.y)
            .attr("class", "fake");
          svg.select(".drag").selectAll(".link")
            .data(links)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", function(link) {
              return 'M' + link[0].x + ',' + link[0].y +
                'C' + link[1].x + ',' + link[1].y +
                ' ' + link[1].x + ',' + link[1].y +
                ' ' + link[2].x + ',' + link[2].y;
            })
        } else if (mode === 'AND') {
          var o;
          if (orientation === 'left') {
            o = match.point.subtract(layout.d);
          } else if (orientation === 'right') {
            o = match.point.add(layout.d);
          }
          svg.select(".drag")
            .append("circle")
            .attr("r", layout.radius)
            .attr("cx", o.x)
            .attr("cy", o.y)
            .attr("class", "fake");
        }
      }
    }
    svg.call(d3.drag()
      .subject(dragsubject)
      .on("start", dragstarted)
      .on("drag", dragged)
      .on("end", dragended)
      .on("start.render drag.render end.render", render));

    function dragsubject() {
      var x = point.x - d3.event.x;
      var y = point.y - d3.event.y;
      if (x * x + y * y < layout.radius * layout.radius) return point;
    }

    function dragstarted() {
      d3.event.subject.active = true;
    }

    function dragged() {
      d3.event.subject.x = d3.event.x;
      d3.event.subject.y = d3.event.y;
      var deltaX = 0,
        deltaY = 0;
      match = null;
      mode = null;
      orientation = null;
      for (var i = 0; i < nodes.length; i++) {
        deltaX = d3.event.x - nodes[i].x;
        deltaY = d3.event.y - nodes[i].y;
        if (deltaY >= layout.radius && deltaY <= layout.radius + layout.diameter && Math.abs(deltaX) <= layout.radius) {
          match = nodes[i];
          mode = 'OR';
          return;
        } else if (Math.abs(deltaY) < layout.radius && Math.abs(deltaX) <= layout.diameter) {
          if (deltaX > 0) {
            match = nodes[i];
            mode = 'AND';
            orientation = 'right';
            return;
          } else if (deltaX < 0) {
            match = nodes[i];
            mode = 'AND';
            orientation = 'left';
            return;
          }
        }
      }
    }

    function dragended() {
      d3.event.subject.active = false;
      if (match) {
        root.each(function(node) {
          if (match === node) {
            node.merge(mode, ++lastValue, orientation);
            // node.remove();
            layout.position(root);
            nodes = root.descendants();
            return false;
          }
        });
        match = null;
        drawTree();
      }
    }
    render();
  </script>
</body>

</html>
